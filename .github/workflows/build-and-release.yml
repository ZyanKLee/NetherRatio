name: Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0, v2.0.1, etc.
  workflow_dispatch: # Allows manual triggering

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn -B package --file pom.xml

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          files: target/NetherRatio-*.jar
          body_path: CHANGELOG.md
          fail_on_unmatched_files: true

      - name: Publish to Hangar
        env:
          HANGAR_TOKEN: ${{ secrets.HANGAR_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          # Upload to Hangar using their API
          # Documentation: https://hangar.papermc.io/api-docs
          
          HANGAR_SLUG="${{ secrets.HANGAR_PROJECT_SLUG }}"
          JAR_FILE=$(ls target/NetherRatio-*.jar)
          
          # Read changelog
          CHANGELOG=$(cat CHANGELOG.md | head -n 50)
          
          # Create version on Hangar
          curl -X POST "https://hangar.papermc.io/api/v1/projects/${HANGAR_SLUG}/versions" \
            -H "Authorization: ${HANGAR_TOKEN}" \
            -H "Content-Type: multipart/form-data" \
            -F "version-string=${VERSION}" \
            -F "channel=Release" \
            -F "platformVersions={\"PAPER\": [\"1.21\", \"1.21.1\", \"1.21.2\", \"1.21.3\", \"1.21.4\", \"1.21.5\", \"1.21.6\", \"1.21.7\", \"1.21.8\", \"1.21.9\", \"1.21.10\", \"1.21.11\"]}" \
            -F "plugin-dependencies={}" \
            -F "files=@${JAR_FILE}"

      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ secrets.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          
          files: target/NetherRatio-*.jar
          name: NetherRatio ${{ steps.version.outputs.VERSION }}
          version: ${{ steps.version.outputs.VERSION }}
          version-type: release
          
          loaders: |
            paper
            spigot
            purpur
          
          game-versions: |
            1.21
            1.21.1
            1.21.2
            1.21.3
            1.21.4
            1.21.5
            1.21.6
            1.21.7
            1.21.8
            1.21.9
            1.21.10
            1.21.11
          
          changelog-file: CHANGELOG.md
          java: |
            21
